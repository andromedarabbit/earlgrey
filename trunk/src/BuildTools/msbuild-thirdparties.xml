<?xml version="1.0" encoding="utf-8"?>
<Project 
	DefaultTargets="PrepareThirdParties"
	xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
	>

<PropertyGroup>
	<Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
	
	<MSBuildCommunityTasksRoot>$(VendorDir)\BuildTool\MSBuildCommunityTasks</MSBuildCommunityTasksRoot>
	<MSBuildCommunityTasksDir>$(MSBuildCommunityTasksRoot)\v1.3.0.504</MSBuildCommunityTasksDir>
	<MSBuildCommunityTasksOutput>$(MSBuildCommunityTasksDir)\build</MSBuildCommunityTasksOutput>
	<MSBuildCommunityTasksBin>$(MSBuildCommunityTasksOutput)\$(Configuration)\bin</MSBuildCommunityTasksBin>
	
	
	<MSBuildCommunityTasksPath>$(MSBuildCommunityTasksDir)-bin\$(Configuration)</MSBuildCommunityTasksPath>
	<MSBuildCommunityTasksTargets>$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets</MSBuildCommunityTasksTargets>
</PropertyGroup>

<!-- 선택적 라이브러리 -->
<PropertyGroup>
	<TempOptionalLibsRootDir>..\..\vendor\Optionals</TempOptionalLibsRootDir>
</PropertyGroup>

<ItemGroup>
	<DeployFiles Include="$(MSBuildCommunityTasksBin)\ICSharpCode.SharpZipLib.dll" />
	<DeployFiles Include="$(MSBuildCommunityTasksBin)\Microsoft.VisualStudio.SourceSafe.Interop.dll" />
	<DeployFiles Include="$(MSBuildCommunityTasksBin)\MSBuild.Community.Tasks.Targets" />
	<DeployFiles Include="$(MSBuildCommunityTasksBin)\MSBuild.Community.Tasks.xml" />
	<DeployFiles Include="$(MSBuildCommunityTasksBin)\MSBuild.Community.Tasks.xsd" />
</ItemGroup>


<Import Project="$(MSBuildCommunityTasksTargets)"/>

<Target Name="BuildMSBuildCommunityTasks">
	<Copy 
		SourceFiles="$(MSBuildCommunityTasksRoot)\MissingFiles\ICSharpCode.SharpZipLib.dll"
		DestinationFolder="$(MSBuildCommunityTasksDir)\Libraries"
		/>
	
	<!-- MSBuild 태스크는 쓰지 말 것: 경로가 꼬인다. -->
	<Exec 
		Command="$(Quot)$(MSBuildExeWrapper)$(Quot) MSBuildTasks.proj /t:Build /p:Configuration=$(Configuration)"
		WorkingDirectory="$(MSBuildCommunityTasksDir)"
	/>
</Target>

<Target Name="CleanMSBuildCommunityTasks">
	<RemoveDir Directories="$(MSBuildCommunityTasksOutput)" />
</Target>

<Target Name="CleanThirdParties" DependsOnTargets="CleanMSBuildCommunityTasks">
</Target>

<Target Name="DeployMSBuildCommunityTasks" DependsOnTargets="BuildMSBuildCommunityTasks">
	<Exec 
		Command="xcopy /y $(Quot)%(DeployFiles.FullPath)$(Quot) $(Quot)$(MSBuildCommunityTasksPath)\$(Quot) " />
	<Exec 
		Command="xcopy /y $(Quot)%(DeployFiles.FullPath)$(Quot) $(Quot)$(BinDir)\$(Quot) " />
</Target>

<Target Name="GetOptionalLibsRootDir" Condition="'$(AlreadyGotOptionalLibsRootDir)' != 'true'">
	<ConvertToAbsolutePath Paths="$(TempOptionalLibsRootDir)">
		<Output TaskParameter="AbsolutePaths" PropertyName="OptionalLibsRootDir"/>
	</ConvertToAbsolutePath>
	
	<CreateProperty Value="true">
		<Output TaskParameter="Value" PropertyName="AlreadyGotOptionalLibsRootDir" />
	</CreateProperty>
</Target>

<Target 
	Name="CheckIfSharedManagementObjects2005Prepared" 
	DependsOnTargets="GetOptionalLibsRootDir" 
	Condition="'$(SharedManagementObjects2005Prepared)' == ''"
>
	<CreateProperty Value="false">
		<Output 
			TaskParameter="Value" 
			PropertyName="SharedManagementObjects2005Prepared"
			Condition="!Exists('$(OptionalLibsRootDir)\SQLServer2005_XMO-x86.msi')"
		/>
	</CreateProperty>
	<CreateProperty Value="true">
		<Output 
			TaskParameter="Value" 
			PropertyName="SharedManagementObjects2005Prepared"
			Condition="Exists('$(OptionalLibsRootDir)\SQLServer2005_XMO-x86.msi')"
		/>
	</CreateProperty>
</Target>

<Target 
	Name="InstallSharedManagementObjects2005" 
	Condition="'$(SharedManagementObjects2005Prepared)' != 'true'"
>
	<!-- 
		Microsoft SQL Server 2005 Management Objects 
		http://download.microsoft.com/download/4/4/D/44DBDE61-B385-4FC2-A67D-48053B8F9FAD/SQLServer2005_XMO.msi
	-->
	<WebDownload 
		FileUri="http://download.microsoft.com/download/4/4/D/44DBDE61-B385-4FC2-A67D-48053B8F9FAD/SQLServer2005_XMO.msi"
		FileName="$(OptionalLibsRootDir)\SQLServer2005_XMO-x86.msi" 
		/>
    
	<MakeDir Directories="$(OptionalLibsRootDir)\Microsoft SQL Server 2005 Management Objects\x86" />
	
	<Exec 
		Command="msiexec /a $(Quot)SQLServer2005_XMO-x86.msi$(Quot) /qb TARGETDIR=$(Quot)$(OptionalLibsRootDir)\Microsoft SQL Server 2005 Management Objects\x86$(Quot)"
		WorkingDirectory="$(OptionalLibsRootDir)" 
	/>
</Target>

<Target 
	Name="PrepareSharedManagementObjects2005" 
	DependsOnTargets="CheckIfSharedManagementObjects2005Prepared; InstallSharedManagementObjects2005"
>
</Target>

<Target 
	Name="CheckIfSharedManagementObjects2008Prepared" 
	DependsOnTargets="GetOptionalLibsRootDir" 
	Condition="'$(SharedManagementObjects2008Prepared)' == ''"
>
	<CreateProperty Value="false">
		<Output 
			TaskParameter="Value" 
			PropertyName="SharedManagementObjects2008Prepared"
			Condition="!Exists('$(OptionalLibsRootDir)\SharedManagementObjects-x86.msi')"
		/>
	</CreateProperty>
	<CreateProperty Value="true">
		<Output 
			TaskParameter="Value" 
			PropertyName="SharedManagementObjects2008Prepared"
			Condition="Exists('$(OptionalLibsRootDir)\SharedManagementObjects-x86.msi')"
		/>
	</CreateProperty>
</Target>

<Target 
	Name="InstallSharedManagementObjects2008" 
	Condition="'$(SharedManagementObjects2008Prepared)' != 'true'"
>
	<!-- 
		Microsoft SQL Server 2008 Management Objects 
		http://www.microsoft.com/downloads/ko-kr/details.aspx?FamilyID=C6C3E9EF-BA29-4A43-8D69-A2BED18FE73C
	-->
	<WebDownload 
		FileUri="http://go.microsoft.com/fwlink/?LinkId=123708$(Ampersand)clcid=0x412"
		FileName="$(OptionalLibsRootDir)\SharedManagementObjects-x86.msi" 
		/>
    
	<MakeDir Directories="$(OptionalLibsRootDir)\Microsoft SQL Server 2008 Management Objects\x86" />
	
	<Exec 
		Command="msiexec /a $(Quot)SharedManagementObjects-x86.msi$(Quot) /qb TARGETDIR=$(Quot)$(OptionalLibsRootDir)\Microsoft SQL Server 2008 Management Objects\x86$(Quot)"
		WorkingDirectory="$(OptionalLibsRootDir)" 
	/>
</Target>


<Target 
	Name="PrepareSharedManagementObjects2008" 
	DependsOnTargets="CheckIfSharedManagementObjects2008Prepared; InstallSharedManagementObjects2008"
>
</Target>


<Target 
	Name="CheckIfWinScpPrepared" 
	DependsOnTargets="GetOptionalLibsRootDir" 
	Condition="'$(WinScpPrepared)' == ''"
>
	<CreateProperty Value="false">
		<Output 
			TaskParameter="Value" 
			PropertyName="WinScpPrepared"
			Condition="!Exists('$(OptionalLibsRootDir)\winscp432.zip')"
		/>
	</CreateProperty>
	<CreateProperty Value="true">
		<Output 
			TaskParameter="Value" 
			PropertyName="WinScpPrepared"
			Condition="Exists('$(OptionalLibsRootDir)\winscp432.zip')"
		/>
	</CreateProperty>
</Target>


<Target 
	Name="InstallWinScp"
	Condition="'$(WinScpPrepared)' != 'true'"
>
	<WebDownload 
		FileUri="http://sourceforge.net/projects/winscp/files/WinSCP/4.3.2/winscp432.zip/download"
		FileName="$(OptionalLibsRootDir)\winscp432.zip" 
		/>

	<Unzip 
		ZipFileName="$(OptionalLibsRootDir)\winscp432.zip"
		TargetDirectory="$(OptionalLibsRootDir)\WinSCP\v4.3.2"
		/>
	
</Target>

<Target Name="DeployWinSCP">
	<RoboCopy 
		SourceFolder="$(OptionalLibsRootDir)\WinSCP\v4.3.2"
		DestinationFolder="$(RootDir)\MSBuild\MSBuild.Earlgrey.Tasks\ExternalTools\WinSCP\v4.3.2"
		AllSubdirectories="true"
		/>
</Target>

<Target Name="PrepareWinScp" DependsOnTargets="CheckIfWinScpPrepared; InstallWinScp; DeployWinSCP">

</Target>

<Target 
	Name="PrepareOptionals" 
	DependsOnTargets="PrepareWinScp; PrepareSharedManagementObjects2005; PrepareSharedManagementObjects2008"
	> 
</Target>

<Target Name="PrepareThirdParties" DependsOnTargets="PrepareOptionals; DeployMSBuildCommunityTasks">
</Target>

</Project>

		